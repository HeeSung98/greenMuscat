<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"
    integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style></style>
</head>

<body>
  <h1>게시물 전체 불러오기, 게시물 작성 (상단 조그맣게) -> 모달 창</h1>

  <!-- 게시물작성페이지로 이동 버튼 -->
  <button onclick="location.href='room/board/register'">게시물작성</button>
  <ul>
    <% for(let i=0; i < data.length; i++){ %>
      <li>
        <!-- 댓글들 -->
        <b>
          <%= data[i] %>
            <button onclick="allReply(<%= i %>)">댓글</button>
            <ul id="replylList<%= i %>"></ul>
            <!-- 댓글들 (해당 작성자)-->
            <div id="reply<%= i %>" style="display: none">
            </div>
            <!-- 댓글 입력 -->
            <form name="addReply" hidden>
              <input type="text" id="inputReply" placeholder="댓글 입력" />
              <button onclick="addReply(<%= i %>)">등록</button>
            </form>
      </li>
      <% } %>
  </ul>
</body>

<script>
  function register() {
    window.location.href = '/main/room/board/register'
  }

  // 댓글 목록 보이기/숨기기 및 댓글 불러오기
  async function allReply(index) {
    // 댓글 보이게 할 부분
    const replyList = document.getElementById(`reply${index}`)
    const replyDiv = document.getElementById(`reply${index}`)
    // 댓글 보이게 할 부분
    if (
      reply.style.display === 'none' ||
      reply.style.display === ''
    ) {
      reply.style.display = 'block'
    } else {
      reply.style.display = 'none'
    }

    const data = { POST_pNo: index }
    // 댓글 불러오기
    try {
      const response = await axios({
        method: 'POST',
        url: '/main/room/board/reply',
        data,
      })

      if (response.data.result) {
        const pReply = response.data.pReply
        replyList.innerHTML = ''

        // 댓글 목록 ul에 추가
        pReply.forEach((reply) => {
          const li = document.createElement('li')
          li.textContent = reply;
          replyList.appendChild(li)
        })
      } else console.log('댓글 불러오기 실패')
    } catch (error) {
      console.log(error)
    }
  }

  // 댓글 등록
  async function addReply(index) {
    const form = document.forms['addReply']
    const inputReply = document.getElementById(`inputReply${index}`)
    const text = form.inputReply.value
    const data = { text }

    try {
      const response = await axios({
        method: 'POST',
        url: '/room/board/reply/register',
        data,
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      })
      if (response.data.result) {
        // 댓글 등록 성공 시 처리
        inputReply.value = ''
        // 댓글 목록 다시 불러오기
        allReply(index)
      } else console.log('댓글 등록 실패')
    } catch (error) {
      console.log(error)
    }
  }
  // 본인이 등록한 댓글이면 수정 삭제 버튼 보이고, 수정 삭제 가능하게

</script>

</html>