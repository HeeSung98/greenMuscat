<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/css/main.css" />
    <title>GreenMuscat</title>
  </head>

  <body>
    <%- include('mainHeader') %>
    <!-- body ì‹œì‘ -->
    <h2 class="mainH2">ë‹‰ë„¤ì„ì˜ í¬ë„ ë†ì¥ğŸ‘¨â€ğŸŒ¾</h2>
    <!-- section ì‹œì‘ -->
    <section class="top">
      <div class="roomCard">
        <div class="roomInfo"></div>
        <p class="roomInfo">í…ŒìŠ¤íŠ¸1 / ê´€ë¦¬ì</p>
      </div>
      <div class="roomCard">
        <div class="roomInfo"></div>
        <p class="roomInfo">í…ŒìŠ¤íŠ¸2 / ì°¸ì—¬ì</p>
      </div>
    </section>
    <section class="bottom">
      <div class="roomBox">
        <h3>ë‹¤ë¥¸ ë†ì¥ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?</h3>
        <div class="modal" id="registerModal">
          <div class="modal_body">
            <h2 class="modalH2">ë†ì¥ ìƒì„±í•˜ê¸°</h2>
            <form name="roomRegisterForm" class="roomRegisterForm">
              <b>ë†ì¥ëª…:</b>
              <input type="text" name="roomTitle" required />
              <br />
              <br />
              <b>ë†ì¥ ì´ë¯¸ì§€:</b>
              <input type="file" id="roomImg" />
            </form>
            <div class="formBtn">
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnRoomRegister()"
              >
                ìƒì„±
              </button>
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnCloseModal(registerModal.id)"
              >
                ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
        <div class="modal" id="entranceModal">
          <div class="modal_body">
            <h2 class="modalH2">ë†ì¥ ê°€ê¸°</h2>
            <form name="roomEntranceForm" class="roomEntranceForm">
              <b>ì…ì¥ ì½”ë“œ:</b>
              <input type="text" name="roomCode" />
            </form>
            <div class="formBtn">
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnRoomEntrance()"
              >
                ì…ì¥
              </button>
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnCloseModal(entranceModal.id)"
              >
                ë‹«ê¸°
              </button>
            </div>
          </div>
        </div>
        <div class="result" id="result"></div>
        <div class="btnBox">
          <button
            class="button btnPush btnBlueGreen"
            type="button"
            onclick="btnOpenModal(registerModal.id)"
          >
            ë†ì¥ ë§Œë“¤ê¸°
          </button>
          <button
            class="button btnPush btnBlueGreen"
            type="button"
            onclick="btnOpenModal(entranceModal.id)"
          >
            ë‹¤ë¥¸ ë†ì¥ê°€ê¸°
          </button>
        </div>
      </div>
    </section>

    <form action="/room" method="post" name="postRoomForm" hidden>
      <input type="text" name="code" />
      <input type="text" name="email" />
    </form>

    <script>
      const entranceForm = document.forms['postRoomForm'] // ë°© ì…ì¥ ì •ë³´ë¥¼ ìœ„í•œ íˆë“  í¼
      const user = JSON.parse(localStorage.getItem('user'))
      console.log('user:', user)

      // ëª¨ë‹¬ì°½ ì—´ê¸°
      function btnOpenModal(id) {
        document.getElementById(id).style.display = 'flex'
      }

      // ëª¨ë‹¬ì°½ ë‹«ê¸°
      function btnCloseModal(id) {
        document.getElementById(id).style.display = 'none'
      }

      // ë°© ì½”ë“œ ìƒì„±ê¸°
      function generateRoomCode(length) {
        const characters =
          'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
        let roomCode = ''

        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length)
          roomCode += characters.charAt(randomIndex)
        }

        return roomCode
      }

      // ë°© ìƒì„± í¼ ë°ì´í„°
      async function btnRoomRegister() {
        const form = document.forms['roomRegisterForm']
        const file = document.querySelector('#roomImg')
        const roomTitleRegex = /^[a-zA-Zê°€-í£\d]{2,30}$/
        if (!roomTitleRegex.test(form.roomTitle.value)) {
          alert('ë°© ì œëª©ì€ 2ì ì´ìƒ, 30ì ì´í•˜ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.')
          form.roomTitle.value = ''
          return false
        }

        const data = new FormData()
        data.append('rTitle', form.roomTitle.value)
        data.append('code', generateRoomCode(10))
        data.append('email', user.email)
        data.append('file', file.files[0])

        const respone = await axios({
          method: 'POST',
          url: '/main/add',
          data,
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        })
        resData = respone.data
        console.log('resData: ', resData)

        if (resData.result) {
          alert(`${resData.message}`)
          const entranceForm = document.forms['postRoomForm']
          console.log('createdRoom: ', resData.createdRoom)
          localStorage.setItem('room', JSON.stringify(resData.createdRoom))
          entranceForm.code.value = resData.createdRoom.code
          entranceForm.email.value = user.email
          entranceForm.submit()
        } else {
          alert(`${resData.message}`)
          form.reset()
        }
      }

      // ë°© ì…ì¥ í¼ ë°ì´í„°
      async function btnRoomEntrance() {
        const form = document.forms['roomEntranceForm']
        const data = {
          email: user.email,
          code: form.roomCode.value,
        }
        console.log('data:', data)

        const respone = await axios({
          method: 'POST',
          url: '/room',
          data,
        })
        resData = respone.data
        console.log('resData: ', resData)

        if (resData.result) {
          alert(`${resData.message}`)
          localStorage.setItem('room', JSON.stringify(resData.findedRoom))
          location.href = '/room'
        } else {
          alert(`${resData.message}`)
        }
      }
    </script>
  </body>
</html>
