<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      .modal {
        position: absolute;
        display: none;

        justify-content: center;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal_body {
        position: absolute;
        top: 50%;

        /* width: 400px;
        height: 600px; */

        padding: 40px;

        text-align: center;

        background-color: rgb(255, 255, 255);
        border-radius: 10px;
        box-shadow: 0 2px 3px 0 rgba(34, 36, 38, 0.15);

        transform: translateY(-50%);
      }

      h2 {
        text-align: center;
        padding: 15px;
        margin: 0 auto;
      }
      .roomBox {
        border: dotted 2px black;
        border-radius: 3%;
        width: 60%;
        height: 300px;
        position: relative;
        margin: 0 auto;
      }
      p {
        text-align: center;
        margin: 15px 0;
        font-weight: 600;
      }
      /* .roomBtn {
        width: 100px;
        height: 100px;
        background-color: antiquewhite;
        text-align: center;
        border-style: solid;
        border-width: 3px;
        margin: 2vw;
      } */
    </style>
    <title>GreenMuscat</title>
  </head>
  <%- include('mainHeader') %>

  <body>
    <h2>ë‹‰ë„¤ì„ ğŸ‘¨â€ğŸŒ¾ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
    <div class="roomBox">
      <p style="font-size: 20px">í¬ë„ ë†ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
      <br />
      <div style="text-align: center">í˜„ì¬ ì¬ë°° ì¤‘ì¸ ë†ì¥ì´ ì—†ì–´ìš”ğŸ˜¢</div>
      <br />
      <p style="font-size: 16px">ë‹¤ë¥¸ ë†ì¥ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?</p>
      <div>
        <div class="modal" id="registerModal">
          <div class="modal_body">
            <h2>ë°© ìƒì„±í•˜ê¸°</h2>
            <form name="roomRegisterForm">
              ë°© ì´ë¦„:
              <input type="text" name="roomTitle" /><br /><br />
              í”„ë¡œí•„ ì´ë¯¸ì§€:
              <input type="file" id="roomImg" /><br /><br />
              <button type="button" onclick="btnRoomRegister()">ìƒì„±</button>
              <button type="button" onclick="btnCloseModal(registerModal.id)">
                ë‹«ê¸°
              </button>
            </form>
          </div>
        </div>

        <div class="modal" id="entranceModal">
          <div class="modal_body">
            <h2>ë°© ì…ì¥í•˜ê¸°</h2>
            <form name="roomEntranceForm">
              ì…ì¥ ì½”ë“œ:
              <input type="text" name="roomCode" /><br /><br />
              <button type="button" onclick="btnRoomEntrance()">ì…ì¥</button>
              <button type="button" onclick="btnCloseModal(entranceModal.id)">
                ë‹«ê¸°
              </button>
            </form>
          </div>
        </div>
        <div class="result" id="result"></div>
        <div class="btnBox" style="text-align: center">
          <button
            class="roomBtn"
            type="button"
            onclick="btnOpenModal(registerModal.id)"
          >
            ë°© ìƒì„±í•˜ê¸°
          </button>
          <button
            class="roomBtn"
            type="button"
            onclick="btnOpenModal(entranceModal.id)"
          >
            ë°© ì…ì¥í•˜ê¸°
          </button>
        </div>
      </div>
    </div>

    <form action="/room" method="post" name="postRoomForm" hidden>
      <input type="text" name="code" />
      <input type="text" name="email" />
    </form>

    <script>
      const user = JSON.parse(localStorage.getItem('user'))
      console.log('user:', user)

      const resultBox = document.querySelector('.result')

      // ëª¨ë‹¬ì°½ ì—´ê¸°
      function btnOpenModal(id) {
        document.getElementById(id).style.display = 'flex'
      }

      // ëª¨ë‹¬ì°½ ë‹«ê¸°
      function btnCloseModal(id) {
        document.getElementById(id).style.display = 'none'
      }

      // ë°© ì½”ë“œ ìƒì„±ê¸°
      function generateRoomCode(length) {
        const characters =
          'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
        let roomCode = ''

        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length)
          roomCode += characters.charAt(randomIndex)
        }

        return roomCode
      }

      // ë°© ìƒì„± í¼ ë°ì´í„°
      async function btnRoomRegister() {
        const form = document.forms['roomRegisterForm']
        const file = document.querySelector('#roomImg')

        const data = new FormData()
        data.append('rTitle', form.roomTitle.value)
        data.append('code', generateRoomCode(10))
        data.append('email', user.email)
        data.append('file', file.files[0])

        const respone = await axios({
          method: 'POST',
          url: '/main/add',
          data,
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        })

        resData = respone.data
        console.log('resData: ', resData)
        if (resData.result) {
          alert(`${resData.message}`)
          const entranceForm = document.forms['postRoomForm']
          console.log('createdRoom: ', resData.createdRoom)
          localStorage.setItem('room', JSON.stringify(resData.createdRoom))
          entranceForm.code.value = resData.createdRoom.code
          entranceForm.email.value = user.email
          entranceForm.submit()
        } else {
          alert(`${resData.message}`)
          form.reset()
        }
      }

      // ë°© ì…ì¥ í¼ ë°ì´í„°
      async function btnRoomEntrance() {
        const form = document.forms['roomEntranceForm']
        const data = {
          email: user.email,
          code: form.roomCode.value,
        }
        console.log('data:', data)

        const respone = await axios({
          method: 'POST',
          url: '/main/entrance',
          data,
        })
        resData = respone.data
        console.log('resData: ', resData)

        if (resData.result) {
          alert(`${resData.message}`)
          btnCloseModal(entranceModal.id)
          document.location.href = '/room'
        } else {
          alert(`${resData.message}`)
          form.reset()
        }
      }
    </script>
  </body>
</html>
