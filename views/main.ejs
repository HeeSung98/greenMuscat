<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/css/main.css" />
    <title>GreenMuscat</title>
  </head>

  <body>
    <%- include('mainHeader') %>
    <!-- body 시작 -->
    <h2 class="mainH2">닉네임의 포도 농장👨‍🌾</h2>
    <!-- section 시작 -->
    <section class="top">
      <div class="roomCard">
        <div class="roomInfo"></div>
        <p class="roomInfo">테스트1 / 관리자</p>
      </div>
      <div class="roomCard">
        <div class="roomInfo"></div>
        <p class="roomInfo">테스트2 / 참여자</p>
      </div>
    </section>
    <section class="bottom">
      <div class="roomBox">
        <h3>다른 농장을 찾으시나요?</h3>
        <div class="modal" id="registerModal">
          <div class="modal_body">
            <h2 class="modalH2">농장 생성하기</h2>
            <form name="roomRegisterForm" class="roomRegisterForm">
              <b>농장명:</b>
              <input type="text" name="roomTitle" required />
              <br />
              <br />
              <b>농장 이미지:</b>
              <input type="file" id="roomImg" />
            </form>
            <div class="formBtn">
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnRoomRegister()"
              >
                생성
              </button>
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnCloseModal(registerModal.id)"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
        <div class="modal" id="entranceModal">
          <div class="modal_body">
            <h2 class="modalH2">농장 가기</h2>
            <form name="roomEntranceForm" class="roomEntranceForm">
              <b>입장 코드:</b>
              <input type="text" name="roomCode" />
            </form>
            <div class="formBtn">
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnRoomEntrance()"
              >
                입장
              </button>
              <button
                type="button"
                class="button btnPush btnBlueGreen"
                onclick="btnCloseModal(entranceModal.id)"
              >
                닫기
              </button>
            </div>
          </div>
        </div>
        <div class="result" id="result"></div>
        <div class="btnBox">
          <button
            class="button btnPush btnBlueGreen"
            type="button"
            onclick="btnOpenModal(registerModal.id)"
          >
            농장 만들기
          </button>
          <button
            class="button btnPush btnBlueGreen"
            type="button"
            onclick="btnOpenModal(entranceModal.id)"
          >
            다른 농장가기
          </button>
        </div>
      </div>
    </section>

    <form action="/room" method="post" name="postRoomForm" hidden>
      <input type="text" name="code" />
      <input type="text" name="email" />
    </form>

    <script>
      const entranceForm = document.forms['postRoomForm'] // 방 입장 정보를 위한 히든 폼
      const user = JSON.parse(localStorage.getItem('user'))
      console.log('user:', user)

      // 모달창 열기
      function btnOpenModal(id) {
        document.getElementById(id).style.display = 'flex'
      }

      // 모달창 닫기
      function btnCloseModal(id) {
        document.getElementById(id).style.display = 'none'
      }

      // 방 코드 생성기
      function generateRoomCode(length) {
        const characters =
          'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
        let roomCode = ''

        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length)
          roomCode += characters.charAt(randomIndex)
        }

        return roomCode
      }

      // 방 생성 폼 데이터
      async function btnRoomRegister() {
        const form = document.forms['roomRegisterForm']
        const file = document.querySelector('#roomImg')
        const roomTitleRegex = /^[a-zA-Z가-힣\d]{2,30}$/
        if (!roomTitleRegex.test(form.roomTitle.value)) {
          alert('방 제목은 2자 이상, 30자 이하로 입력해 주세요.')
          form.roomTitle.value = ''
          return false
        }

        const data = new FormData()
        data.append('rTitle', form.roomTitle.value)
        data.append('code', generateRoomCode(10))
        data.append('email', user.email)
        data.append('file', file.files[0])

        const respone = await axios({
          method: 'POST',
          url: '/main/add',
          data,
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        })
        resData = respone.data
        console.log('resData: ', resData)

        if (resData.result) {
          alert(`${resData.message}`)
          const entranceForm = document.forms['postRoomForm']
          console.log('createdRoom: ', resData.createdRoom)
          localStorage.setItem('room', JSON.stringify(resData.createdRoom))
          entranceForm.code.value = resData.createdRoom.code
          entranceForm.email.value = user.email
          entranceForm.submit()
        } else {
          alert(`${resData.message}`)
          form.reset()
        }
      }

      // 방 입장 폼 데이터
      async function btnRoomEntrance() {
        const form = document.forms['roomEntranceForm']
        const data = {
          email: user.email,
          code: form.roomCode.value,
        }
        console.log('data:', data)

        const respone = await axios({
          method: 'POST',
          url: '/room',
          data,
        })
        resData = respone.data
        console.log('resData: ', resData)

        if (resData.result) {
          alert(`${resData.message}`)
          localStorage.setItem('room', JSON.stringify(resData.findedRoom))
          location.href = '/room'
        } else {
          alert(`${resData.message}`)
        }
      }
    </script>
  </body>
</html>
