<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/img/icon.ico" type="image/x-icon" />
    <link rel="icon" href="/img/icon.ico" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/css/main.css" />
    <title>GreenMuscat</title>
  </head>

  <body>
    <%- include('mainHeader') %>
    <!-- body ì‹œì‘ -->
    <div class="main">
      <h2 class="mainH2" id="nick">ë‹‰ë„¤ì„ì˜ í¬ë„ ë†ì¥ğŸ‘¨â€ğŸŒ¾</h2>
      <!-- section ì‹œì‘ -->
      <section class="top">
        <% for(let i=0; i < roomList.length; i++) { %>
        <div class="roomDiv">
          <button
            type="button"
            class="roomBtn btnPush"
            onclick="imgRoomEntrance('<%= roomList[i].ROOM_code %>', '<%= roomList[i].role %>')"
          >
            <% if (roomList[i].ROOM_rImg) {%>
            <img src="<%= roomList[i].ROOM_rImg %>" id="rImg_1" />
            <% } else {%>
            <img src="/img/earth.svg" width="50" />
            <% } %>
          </button>
          <p class="btnName">
            <b> <%= roomList[i].ROOM_rTitle %> </b> / <%= roomList[i].role %>
          </p>
        </div>
        <% } %>
        <div class="roomDiv">
          <button
            type="button"
            class="roomBtn btnPush"
            onclick="btnOpenModal(registerModal.id)"
          >
            â•
          </button>
          <p class="btnName"><b>ë†ì¥ ë§Œë“¤ê¸°</b></p>
        </div>
      </section>
      <br />
      <br />
      <section class="bottom">
        <div class="roomBox">
          <h3>ë‹¤ë¥¸ ë†ì¥ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?</h3>
          <!-- <div class="btnBox">
            <button class="button btnPush btnOk" type="button" onclick="btnOpenModal(registerModal.id)">
              ë†ì¥ ë§Œë“¤ê¸°
            </button> -->
          <button
            class="button btnPush btnOk"
            type="button"
            onclick="btnOpenModal(entranceModal.id)"
          >
            ë‹¤ë¥¸ ë†ì¥ê°€ê¸°
          </button>
        </div>
      </section>
      <!-- ëª¨ë‹¬ ë¶€ë¶„ -->
      <!-- ë†ì¥ ìƒì„±í•˜ëŠ” modal  -->
      <div class="modal" id="registerModal">
        <div class="modal_body">
          <h2 class="modalH2">ë†ì¥ ìƒì„±í•˜ê¸°</h2>
          <form name="roomRegisterForm" class="roomRegisterForm">
            <b>ë†ì¥ëª…:</b>
            <input type="text" name="roomTitle" />
            <br />
            <br />
            <b>ë†ì¥ ì´ë¯¸ì§€:</b>
            <input type="file" id="roomImg" />
          </form>
          <div class="formBtn">
            <button
              type="button"
              class="button btnPush btnOk"
              onclick="btnRoomRegister()"
            >
              ìƒì„±
            </button>
            <button
              type="button"
              class="button btnPush btnNo"
              onclick="btnCloseModal(registerModal.id)"
            >
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>
      <!-- ë‹¤ë¥¸ ë†ì¥ ê°€ëŠ” modal -->
      <div class="modal" id="entranceModal">
        <div class="modal_body">
          <h2 class="modalH2">ë†ì¥ ê°€ê¸°</h2>
          <form name="roomEntranceForm" class="roomEntranceForm">
            <b>ì…ì¥ ì½”ë“œ:</b>
            <input type="text" name="roomCode" />
          </form>
          <div class="formBtn">
            <button
              type="button"
              class="button btnPush btnOk"
              onclick="btnRoomEntrance()"
            >
              ì…ì¥
            </button>
            <button
              type="button"
              class="button btnPush btnNo"
              onclick="btnCloseModal(entranceModal.id)"
            >
              ë‹«ê¸°
            </button>
          </div>
        </div>
        <div class="result" id="result"></div>
      </div>

      <form action="/room" method="post" name="entranceForm" hidden>
        <input type="text" name="code" />
        <input type="text" name="email" />
        <input type="text" name="case" />
        <input type="number" name="firstEntrance" />
      </form>
    </div>

    <script>
      const entranceForm = document.forms['entranceForm'] // ë°© ì…ì¥ ì •ë³´ë¥¼ ìœ„í•œ íˆë“  í¼
      const user = JSON.parse(localStorage.getItem('user'))
      const nickname = document.querySelector('#nickname')
      console.log('user:', user)

      document.querySelector('#nick').innerHTML =
        user.nickname + 'ì˜ í¬ë„ ë†ì¥ğŸ‘¨â€ğŸŒ¾'

      // ëª¨ë‹¬ì°½ ì—´ê¸°
      function btnOpenModal(id) {
        document.getElementById(id).style.display = 'flex'
      }

      // ëª¨ë‹¬ì°½ ë‹«ê¸°
      function btnCloseModal(id) {
        document.getElementById(id).style.display = 'none'
      }

      // ë°© ì½”ë“œ ìƒì„±ê¸°
      function generateRoomCode(length) {
        const characters =
          'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
        let roomCode = ''

        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * characters.length)
          roomCode += characters.charAt(randomIndex)
        }

        return roomCode
      }

      // ë°© ìƒì„± í¼ ë°ì´í„°
      async function btnRoomRegister() {
        const form = document.forms['roomRegisterForm']
        const file = document.querySelector('#roomImg')
        const roomRegex = /.{2,30}/
        if (!roomRegex.test(form.roomTitle.value)) {
          alert('ë°© ì œëª©ì€ 2ì ì´ìƒ, 30ì ì´í•˜ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.')
          form.roomTitle.value = ''
          return false
        }

        const data = new FormData()
        data.append('rTitle', form.roomTitle.value)
        data.append('code', generateRoomCode(10))
        data.append('email', user.email)
        data.append('file', file.files[0])

        const respone = await axios({
          method: 'POST',
          url: '/main/add',
          data,
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        })
        resData = respone.data
        console.log('resData: ', resData)

        if (resData.result) {
          alert(`${resData.message}`)
          console.log('createdRoom: ', resData.createdRoom)

          localStorage.setItem('room', JSON.stringify(resData.createdRoom))
          localStorage.setItem('userRole', 'admin')

          entranceForm.code.value = resData.createdRoom.code
          entranceForm.email.value = user.email
          entranceForm.firstEntrance.value = 1

          entranceForm.submit()
        } else {
          alert(`${resData.message}`)
          form.reset()
        }
      }

      // ë°© ì…ì¥ í¼ ë°ì´í„°
      async function btnRoomEntrance(role) {
        const form = document.forms['roomEntranceForm']
        const roomRegex = /^[a-zA-Z\d]{10}$/
        if (!roomRegex.test(form.roomCode.value)) {
          alert('ë°© ì½”ë“œëŠ” 10ìì˜ ëŒ€ì†Œë¬¸ìì™€ ìˆ«ìë§Œ í—ˆìš©ë©ë‹ˆë‹¤.')
          form.roomCode.value = ''
          return false
        }

        const data = {
          email: user.email,
          code: form.roomCode.value,
        }
        console.log('data:', data)

        const respone = await axios({
          method: 'POST',
          url: '/room/find',
          data,
        })
        resData = respone.data
        console.log('resData: ', resData)

        if (resData.result) {
          alert(`${resData.message}`)

          localStorage.setItem('room', JSON.stringify(resData.findedRoom))
          localStorage.setItem('userRole', 'member')

          entranceForm.code.value = resData.findedRoom.code
          entranceForm.email.value = user.email
          entranceForm.firstEntrance.value = 1
          entranceForm.submit()
        } else {
          alert(`${resData.message}`)
        }
      }

      // ë°© ì…ì¥ ì´ë¯¸ì§€ í´ë¦­
      async function imgRoomEntrance(code, role) {
        console.log('code, role:', code, role)

        const data = {
          email: user.email,
          code,
        }
        console.log('data:', data)

        const respone = await axios({
          method: 'POST',
          url: '/room/find',
          data,
        })
        resData = respone.data
        console.log('resData: ', resData)

        localStorage.setItem('room', JSON.stringify(resData.findedRoom))
        localStorage.setItem('userRole', role)

        entranceForm.code.value = code
        entranceForm.email.value = user.email
        entranceForm.firstEntrance.value = 0
        entranceForm.submit()
      }
    </script>
  </body>
</html>
